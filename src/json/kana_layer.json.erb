<%=
require "json"
RAISE_KEYS = {
    "かな" => "japanese_kana",
    "international1" => "international1",
}
RAISE_KEY_PRESEED = "raise key pressed"
KEYMAP = {
    i: "up_arrow",
    j: "left_arrow",
    k: "down_arrow",
    l: "right_arrow",
    o: "delete_or_backspace",
    semicolon: "return_or_enter",
    quote: "grave_accent_and_tilde",
    spacebar: {key_code: "hyphen", modifiers: ["left_shift"]},
    q: "escape",
    w: {key_code: "equal_sign", modifiers: ["left_shift"]},
    e: {key_code: "open_bracket", modifiers: ["left_shift"]},
    r: {key_code: "close_bracket", modifiers: ["left_shift"]},
    t: {key_code: "grave_accent_and_tilde", modifiers: ["left_shift"]},
    a: "hyphen",
    s: "equal_sign",
    d: {key_code: "9", modifiers: ["left_shift"]},
    f: {key_code: "0", modifiers: ["left_shift"]},
    g: {key_code: "backslash", modifiers: ["left_shift"]},
    z: {key_code: "comma", modifiers: ["left_shift"]},
    x: {key_code: "period", modifiers: ["left_shift"]},
    c: "open_bracket",
    v: "close_bracket",
    b: "backslash",
    "1": "f1",
    "2": "f2",
    "3": "f3",
    "4": "f4",
    "5": "f5",
    "6": "f6",
    "7": "f7",
    "8": "f8",
    "9": "f9",
    "0": "f10",
    hyphen: "f11",
    equal_sign: "f12",
}

rules = RAISE_KEYS.map do |raise_key_label, raise_key|
    {
        description: "Use #{raise_key_label} to change layer",
        manipulators: [
            *KEYMAP.map {|from, to|
                to = case to
                when String
                    {key_code: to}
                else
                    to
                end

                {
                    type: "basic",
                    from: {
                        key_code: from,
                        modifiers: {optional: %w(any)},
                    },
                    to: [to],
                    conditions: [{
                        type: "variable_if",
                        name: RAISE_KEY_PRESEED,
                        value: 1,
                    }],
                }
            },
            {
                type: "basic",
                from: {
                    key_code: raise_key,
                    modifiers: {optional: %w(any)},
                },
                to: [{
                    set_variable: {
                        name: RAISE_KEY_PRESEED,
                        value: 1,
                    },
                }],
                to_if_alone: [{
                    key_code: raise_key,
                }],
                to_after_key_up: [{
                    set_variable: {
                        name: RAISE_KEY_PRESEED,
                        value: 0,
                    },
                }]
            },
        ],
    }
end

h = {
    title: "Use raise key to change layer",
    rules: rules,
}

JSON.pretty_generate(h)
%>
